<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Profile</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <p></p>
    <div class="row">
        <div class="container">
            <div class="col-md-8  col-md-offset-2">
                <div class="card">

                    <div class="row">

                        <div class="col-md-6">
                            <video controls id="v2" width="300" height="200" autoplay="true">
                                <source>
                                </source>
                            </video>
                        </div>
                        <div class="col-md-6">
                            <canvas id="c1" style="border:1px black solid;"></canvas>
                        </div>

                    </div>

                    <div class="card-body text-center">
                        <h4 class="card-title">John Doe</h4>
                        <p class="card-text text-muted">UI/UX Designer</p>
                        <p class="mt-4"><a href="#" class="btn btn-primary" onclick="startCounting(this)"><i
                                    class="glyphicon glyphicon-camera"></i> Capturer</a></p><span class="compt"> </span>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        var captured

        const vlib = {
            FPS: 30,
            init() {
                this.canvas = document.querySelector('#c1')
                this.video = document.querySelector('#v2')
                this.ctx = this.canvas.getContext('2d')
                this.w = this.canvas.width = this.video.width
                this.h = this.canvas.height = this.video.height
                this.video.addEventListener('play', _ => this.copy())
                this.startCamera()

            },
            copy() {
                this.ctx.drawImage(this.video, 0, 0, this.w, this.h)
                this.process()
                if (this.video.ended || this.video.paused)
                    return

                this.captured = setTimeout(_ => this.copy(), 1000 / this.FPS)
            },
            capturer() {

                clearInterval(this.captured)
                this.ctx.drawImage(this.video, 0, 0, this.w, this.h)

                let base64String = this.canvas.toDataURL();
                alert(base64String)

                //this.process()

            },
            process() {
                const imageData = this.ctx.getImageData(0, 0, this.w, this.h),
                    data = imageData.data
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i + 1], b = data[i + 2], a = data[i + 3]
                    //data[i] = data[i + 1] = data[i + 2] = (r + g + b) / 3

                }
                this.ctx.putImageData(imageData, 0, 0)

            },
            async startCamera() {
                this.video2 = document.querySelector('#v2')
                let stream
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true })
                    this.video2.srcObject = stream
                } catch (error) {
                    console.log("something was wrong")
                    videoReplace = document.querySelector('#v2')


                    videoReplace.src = "Big_Buck_Bunny_Trailer.mp4"


                }
            }
        }
        vlib.init()

        function startCounting(link) {

            this.captured = false
            spanChrono = document.querySelector('.compt')

            var cc = 4;

            link.classList.add('btn-default');
            link.classList.remove('btn-primary');
            link.onclick = null;

            var interval = setInterval(function () {
                spanChrono.innerHTML = '  <i class="glyphicon glyphicon-time"></i>  ' + --cc + ' s';

                if (cc == 0) {
                    clearInterval(interval);

                    link.classList.add('btn-primary');
                    link.classList.remove('btn-default');
                    link.onclick = "startCounting(" + link + ")";

                    link.onclick = function () {
                        startCounting(link)
                    }
                    vlib.capturer()
                    spanChrono.innerHTML = ""
                }

            }, 1000);

        }

    </script>

</body>

</html>