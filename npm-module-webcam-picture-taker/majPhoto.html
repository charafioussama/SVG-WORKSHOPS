<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Profile</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        input#contrast,
        input#hue,
        input#saturation,
        input#lightness {
            -webkit-appearance: none;
            margin: 8px 0;
            padding: 10px 25px 10px 5px;
            width: 100%;
        }

        input#contrast:focus,
        input#hue:focus,
        input#saturation,
        input#lightness {
            outline: none;
        }

        input#contrast::-webkit-slider-runnable-track,
        input#saturation::-webkit-slider-runnable-track,
        input#lightness::-webkit-slider-runnable-track {
            width: 100%;
            height: 12.8px;
            cursor: pointer;
            animate: 0.2s;
            box-shadow: 0px 0px 0px #000000, 0px 0px 0px #0d0d0d;
            background: beige;
            border-radius: 25px;
            border: 0px solid #000101;
        }

        input#contrast::-webkit-slider-thumb,
        input#hue::-webkit-slider-thumb,
        input#saturation::-webkit-slider-thumb,
        input#lightness::-webkit-slider-thumb {
            box-shadow: 0px 0px 0px #000000, 0px 0px 0px #0d0d0d;
            border: 0px solid #000000;
            height: 20px;
            width: 39px;
            border-radius: 7px;
            background: grey;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -3.6px;
        }

        input#contrast:focus::-webkit-slider-runnable-track,
        input#saturation:focus::-webkit-slider-runnable-track,
        input#lightness:focus::-webkit-slider-runnable-track {
            background: palegoldenrod;
        }



        input#hue::-webkit-slider-runnable-track {
            width: 100%;
            height: 12.8px;
            cursor: pointer;
            animate: 0.2s;
            box-shadow: 0px 0px 0px #000000, 0px 0px 0px #0d0d0d;
            background: linear-gradient(to right, hsl(0, 100%, 88%) 0%, hsl(30, 100%, 88%) 8.3%, hsl(60, 100%, 88%) 16.6%, hsl(90, 100%, 88%) 25%, hsl(120, 100%, 88%) 33.3%, hsl(150, 100%, 88%) 41.6%, hsl(180, 100%, 88%) 50%, hsl(210, 100%, 88%) 58.3%, hsl(240, 100%, 88%) 66.6%, hsl(270, 100%, 88%) 75%, hsl(300, 100%, 88%) 83.3%, hsl(330, 100%, 88%) 91.6%, hsl(360, 100%, 88%) 100%);
            border-radius: 25px;
            border: 0px solid #000101;
        }

        body {
            padding: 30px;
        }

        .parent {
            position: relative;
        }

        .cropper-dragger {
            position: absolute;
            display: none;
            left: 50px;
            top: 50px;
        }

        .reverse-cropper-dragger {
            position: absolute;
            left: 50px;
            bottom: 50px;
        }

        .frame {
            width: 130px;
            height: 130px;
            border: 2px solid black;
            position: absolute;

        }

        .point {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: black;
            padding:5px;
        }
    </style>
</head>

<body>
    <p></p>

    <div class="row">
        <div class="container">
            <div class="col-md-10  col-md-offset-2">
                <div class="card">

                    <div class="row">

                        <div class="col-md-6">
                            <video id="v2" width="330" height="250" autoplay="true">
                                <source>
                                </source>
                            </video>
                            <div id="edit" style="display: none;padding: 5px;">
                                <input type="range" id="contrast" min="0" max="100" value="100">
                                <input type="range" id="hue" min="0" max="360" value="0">
                                <input type="range" id="saturation" min="0" max="200" value="100">
                                <input type="range" id="lightness" min="0" max="200" value="100">
                            </div>
                        </div>
                        <div class="col-md-6 parent" style="width: 330px;height: 250px;padding :0;">

                            <div>
                                <canvas id="c1" style="border:1px black solid;"></canvas>
                            </div>

                            <div class="cropper-dragger" style="width: 130px;height: 130px;">

                                <div class="frame" onmousedown='mydragg.startMoving(this.parentNode,"parent",event);'
                                    onmouseup='mydragg.stopMoving("parent");'>
                                </div>

                                <div class="point" id="pr1" style="right: -3px;top: -3px;"></div>
                                <div class="point" id="pr2" style="left: -3px;top: -3px;"></div>
                                <div class="point" id="pr3" style="right: 60px;top: -3px;"></div>
                                <div class="point" id="pr4" style="left: -3px;top: 60px;"></div>

                                <div class="point" id="pr5" style="left: -3px;bottom: -3px;"></div>
                                <div class="point" id="pr6" style="right: 60px;bottom: -3px;"></div>
                                <div class="point" id="pr7" style="right: -3px;bottom: -3px;"></div>
                                <div class="point" id="pr8" style="right: -3px;bottom: 60px;"></div>
                            </div>

                        </div>



                    </div>
                    <div class="row">

                        <div class="card-body text-center">

                            <h4 class="card-title">CHARAFI Oussama</h4>
                            <p class="card-text text-muted">UI/UX Designer</p>
                            <p class="mt-4"><a href="#" class="btn btn-primary" onclick="startCounting(this)"><i
                                        class="glyphicon glyphicon-camera"></i> Capturer</a>

                                <a href="#" class="btn btn-primary" onclick="saveImageProfil()"><i
                                        class="glyphicon glyphicon-save"></i> Save</a>
                                <a href="#" class="btn btn-primary" onclick="showEditDiv()"><i
                                        class="glyphicon glyphicon-edit"></i> Edit</a>
                                <a href="#" class="btn btn-primary" onclick="showCropper()"><i
                                        class="glyphic  on glyphicon-resize-small"></i> Crop</a>
                            </p>
                            <span class="compt"> </span>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <script>

            var captured

            const vlib = {
                FPS: 30,
                init() {
                    this.canvas = document.querySelector('#c1')
                    this.video = document.querySelector('#v2')
                    this.ctx = this.canvas.getContext('2d')
                    this.w = this.canvas.width = document.querySelector('.parent').offsetWidth
                    this.h = this.canvas.height = document.querySelector('.parent').offsetHeight
                    this.video.addEventListener('play', _ => this.copy())
                    this.startCamera()

                },
                copy() {
                    this.ctx.drawImage(this.video, 0, 0, this.w, this.h)
                    this.process()
                    if (this.video.ended || this.video.paused)
                        return
                    this.captured = setTimeout(_ => this.copy(), 1000 / this.FPS)
                },
                capturer() {

                    clearInterval(this.captured)
                    applyFilter(this.ctx)

                    this.ctx.drawImage(this.video, 0, 0, this.w, this.h)
                    applyFilterSt(this.video)

                },
                process() {
                    const imageData = this.ctx.getImageData(0, 0, this.w, this.h)
                    applyFilter(this.ctx)

                    /*
                    for (let i = 0; i < d.length; i += 4) {
    
                        const r = d[i], g = d[i + 1], b = d[i + 2], a = d[i + 3]
    
                        d[i] = d[i] * contrast + intercept;
                        d[i + 1] = d[i + 1] * contrast + intercept;
                        d[i + 2] = d[i + 2] * contrast + intercept;
    
    
                        //data[i] = data[i + 1] = data[i + 2] = (r + g + b) / 3
                    }*/
                    this.ctx.putImageData(imageData, 0, 0)

                },
                async startCamera() {
                    this.video2 = document.querySelector('#v2')
                    let stream
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true })
                        this.video2.srcObject = stream



                    } catch (error) {
                        console.log("something was wrong")
                        videoReplace = document.querySelector('#v2')
                        videoReplace.src = "Big_Buck_Bunny_Trailer.mp4"
                    }
                }
            }
            vlib.init()

            function startCounting(link) {

                this.captured = false
                spanChrono = document.querySelector('.compt')

                var cc = 4;

                link.classList.add('btn-default');
                link.classList.remove('btn-primary');
                link.onclick = null;

                var interval = setInterval(function () {
                    spanChrono.innerHTML = '  <i class="glyphicon glyphicon-time"></i>  ' + --cc + ' s';

                    if (cc == 0) {
                        clearInterval(interval);

                        link.classList.add('btn-primary');
                        link.classList.remove('btn-default');
                        link.onclick = "startCounting(" + link + ")";

                        link.onclick = function () {
                            startCounting(link)
                        }
                        spanChrono.innerHTML = ""
                        vlib.capturer()
                    }

                }, 1000);
            }

            function saveImageProfil() {
                let imgData = vlib.canvas.toDataURL("image/png");
                localStorage.setItem("imgData", imgData.replace(/^data:image\/(png|jpg);base64,/, ""));
                window.location = "profile.html";
            }

            function showEditDiv() {
                let state = document.getElementById('edit').style.display;
                if (state == "block")
                    document.getElementById('edit').style.display = "none";
                else
                    document.getElementById('edit').style.display = "block";

            }

            vi = document.querySelector('#v2')

            /*
                    function contrastImage(imgData, contrast) {	//input range [-100..100]
                        var d = imgData.data;
                        contrast = (contrast / 100) + 1;	//convert to decimal & shift range: [0..2]
                        var intercept = 128 * (1 - contrast);
                        for (var i = 0; i < d.length; i += 4) {	//r,g,b,a
                            d[i] = d[i] * contrast + intercept;
                            d[i + 1] = d[i + 1] * contrast + intercept;
                            d[i + 2] = d[i + 2] * contrast + intercept;
                        }
            
            
                    }
                    */
            function applyFilter(ctx) {
                ctx.filter = 'contrast(' + contr + '%) hue-rotate(' + hu + 'deg) saturate(' + sat + '%) brightness(' + ligh + '%)';
                vi.style.filter = ctx.filter;
            }

            function applyFilterSt(vi) {
                vi.style.filter = 'contrast(' + contr + '%) hue-rotate(' + hu + 'deg) saturate(' + sat + '%) brightness(' + ligh + '%)';
                setTimeout(_ => applyFilterSt(vi), 1000 / this.FPS)

            }

            var rng1 = document.querySelector("#contrast"),
                rng2 = document.querySelector("#hue"),
                rng3 = document.querySelector("#saturation"),
                rng4 = document.querySelector("#lightness")

            var contr = rng1.value, hu = rng2.value, sat = rng3.value, ligh = rng4.value


            rng1.addEventListener('change', (evt) => {
                contr = rng1.value;
            })
            rng2.addEventListener('change', (evt) => {
                hu = rng2.value;
            })
            rng3.addEventListener('change', (evt) => {
                sat = rng3.value;
            })
            rng4.addEventListener('change', (evt) => {
                ligh = rng4.value;
            })
            /*
                    var operations = {
            
                        rgbToHsl: function (r, g, b) {
                            r /= 255, g /= 255, b /= 255;
                            var max = Math.max(r, g, b), min = Math.min(r, g, b);
                            var h, s, l = (max + min) / 2;
                            if (max == min) {
                                h = s = 0; // achromatic
                            } else {
                                var d = max - min;
                                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                                switch (max) {
                                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                                    case g: h = (b - r) / d + 2; break;
                                    case b: h = (r - g) / d + 4; break;
                                }
                                h /= 6;
                            }
                            return ({ h: h, s: s, l: l });
                        },
                        hslToRgb: function (h, s, l) {
                            if (h == "") h = 0;
                            if (s == "") s = 0;
                            if (l == "") l = 0;
                            h = parseFloat(h);
                            s = parseFloat(s);
                            l = parseFloat(l);
                            if (h < 0) h = 0;
                            if (s < 0) s = 0;
                            if (l < 0) l = 0;
                            if (h >= 360) h = 359;
                            if (s > 100) s = 100;
                            if (l > 100) l = 100;
                            s /= 100;
                            l /= 100;
                            C = (1 - Math.abs(2 * l - 1)) * s;
                            hh = h / 60;
                            X = C * (1 - Math.abs(hh % 2 - 1));
                            r = g = b = 0;
                            if (hh >= 0 && hh < 1) {
                                r = C;
                                g = X;
                            } else if (hh >= 1 && hh < 2) {
                                r = X;
                                g = C;
                            } else if (hh >= 2 && hh < 3) {
                                g = C;
                                b = X;
                            } else if (hh >= 3 && hh < 4) {
                                g = X;
                                b = C;
                            } else if (hh >= 4 && hh < 5) {
                                r = X;
                                b = C;
                            } else {
                                r = C;
                                b = X;
                            }
                            m = l - C / 2;
                            r += m;
                            g += m;
                            b += m;
                            return ({ r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) });
            
            
                        }
                    };
            
            
                    function calc() {
            
            
            
                    }
            */


            function showCropper() {

                let state = document.querySelector('.cropper-dragger').style.display;
                if (state == "block")
                    document.querySelector('.col-md-6 .cropper-dragger').style.display = "none";
                else {
                    document.querySelector('.col-md-6 .cropper-dragger').style.display = "block";
                    console.log(state)
                }


            }



            var mydragg = function () {
                return {
                    move: function (divid, xpos, ypos) {
                        divid.style.left = xpos + 'px';
                        divid.style.top = ypos + 'px';
                    },
                    startMoving: function (divid, container, evt) {

                        var style = getComputedStyle(divid);


                        evt = evt || window.event;
                        var posX = evt.clientX,
                            posY = evt.clientY,
                            divTop = style.top,
                            divLeft = style.left,
                            eWi = parseInt(divid.style.width),
                            eHe = parseInt(divid.style.height),
                            cWi = parseInt(document.querySelector('.' + container).offsetWidth) + 2,
                            cHe = parseInt(document.querySelector('.' + container).offsetHeight) + 2;
                        document.querySelector('.' + container).style.cursor = 'move';


                        divTop = divTop.replace('px', '');
                        divLeft = divLeft.replace('px', '');
                        var diffX = posX - divLeft,
                            diffY = posY - divTop;
                        document.onmousemove = function (evt) {
                            evt = evt || window.event;
                            var posX = evt.clientX,
                                posY = evt.clientY,
                                aX = posX - diffX,
                                aY = posY - diffY;
                            if (aX < 0) aX = 0;
                            if (aY < 0) aY = 0;
                            if (aX + eWi > cWi) aX = cWi - eWi;
                            if (aY + eHe > cHe) aY = cHe - eHe;
                            mydragg.move(divid, aX, aY);
                        }
                    },
                    stopMoving: function (container) {
                        var a = document.createElement('script');
                        document.querySelector('.' + container).style.cursor = 'default';
                        document.onmousemove = function () { }
                    },
                }
            }();


            var resizable = document.querySelector('.cropper-dragger'),
                resizer1 = document.querySelector('#pr7'),
                resizer2 = document.querySelector('#pr6'),


                parent = document.querySelector('.parent'),
                frame = document.querySelector('.frame'),
                resizer3 = document.querySelector('#pr3'),
                resizer4 = document.querySelector('#pr4'),
                resizer5 = document.querySelector('#pr8')

                var rect = parent.getBoundingClientRect();

            var topx = 50, btmx = 50;
            var i=0;
 
            resizer1.style.background = 'red';
            resizer1.style.cursor = 'se-resize';
            resizer1.addEventListener('mousedown', initResize, false);

            resizer2.style.background = 'blue';
            resizer2.style.cursor = 'n-resize';
            resizer2.addEventListener('mousedown', initResize, false);

            resizer3.style.background = 'aqua';
            resizer3.style.cursor = 'n-resize';
            resizer3.addEventListener('mousedown', initResize, false);

            resizer4.style.background = 'orange';
            resizer4.style.cursor = 'ew-resize';
            resizer4.addEventListener('mousedown', initResize, false);

            resizer5.style.background = 'gray';
            resizer5.style.cursor = 'ew-resize';
            resizer5.addEventListener('mousedown', initResize, false);

            function initResize(e) {

                document.addEventListener('mousemove', Resize, false);
                document.addEventListener('mouseup', stopResize, false);



            }
            function Resize(e) {
                console.log(e.target.id)


                if (e.clientX > rect.right || e.clientY > rect.bottom) {
                    return;
                }

                if (e.target.id == "pr6") {


                    console.log(e)


                    resizable.className = ""
                    resizable.className = "cropper-dragger"


                    resizable.style.top = btmx+"px"
                   

                    resizable.style.height = (e.clientY - rect.top - resizable.offsetTop) + 'px';
                    frame.style.height = resizable.style.height
                    pr4.style.top = (e.clientY - rect.top - resizable.offsetTop) / 2 + 'px'
                    pr8.style.bottom = (e.clientY - rect.top - 20 - resizable.offsetTop) / 2 + 'px'

                    topx = btmx
                    i=0

                } else if (e.target.id == "pr3") {

                    resizable.className = ""
                    resizable.className = "reverse-cropper-dragger"
                    resizable.style.top=""


                    if(i==0){
                    resizable.style.bottom = rect.height - topx - resizable.offsetHeight+'px'
                    }

                    resizable.style.height = (e.clientY - rect.top - resizable.offsetTop + resizable.offsetHeight) + 'px';
                    frame.style.height = resizable.style.height

                    btmx = resizable.offsetTop
                    i++

                    pr4.style.top = (e.clientY - rect.top+ 10 - resizable.offsetTop + resizable.offsetHeight) / 2 + 'px'
                    pr8.style.bottom = (e.clientY - rect.top- 20 - resizable.offsetTop + resizable.offsetHeight) / 2 + 'px'

                } else if (e.target.id == "pr4") {

                    console.log("resizerornge problem")


                }
                else if (e.target.id == "pr8") {



                    console.log("resizergray")

                    resizable.style.width = (e.clientX - rect.left - resizable.offsetLeft) + 'px';
                    frame.style.width = resizable.style.width
                    pr3.style.left = (e.clientX - rect.left - resizable.offsetLeft) / 2 + 'px'
                    pr6.style.left = (e.clientX - rect.left - resizable.offsetLeft) / 2 + 'px'


                }

                else if (e.target.id == "pr7") {
                    console.log("la")

                    resizable.style.width = (e.clientX - rect.left - resizable.offsetLeft) + 'px';
                    resizable.style.height = (e.clientY - rect.top - resizable.offsetTop) + 'px';

                    pr3.style.right = (e.clientX - rect.left - resizable.offsetLeft) / 2 + 'px'
                    pr4.style.top = (e.clientY - rect.top - resizable.offsetTop) / 2 + 'px'
                    pr6.style.left = (e.clientX - rect.left - resizable.offsetLeft) / 2 + 'px'
                    pr8.style.bottom = (e.clientY - rect.top - 20 - resizable.offsetTop) / 2 + 'px'

                    frame.style.width = resizable.style.width
                    frame.style.height = resizable.style.height

                }


                pr8.style.background = 'green';




            }
            function stopResize(e) {
                console.log("stop")

                document.removeEventListener('mousemove', Resize, false);
                document.removeEventListener('mouseup', stopResize, false);

            }

        </script>

</body>

</html>